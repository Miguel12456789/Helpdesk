<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="base_gov.css">
    <!-- Include Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Helpdesk Público</title>
</head>

<body>
    <main class="container py-8">
        <h1 class="titulo">Mercado Público</h1>
        <div class="banner">
            <p>
                Bem-vindos à página de estatísticas do Helpdesk Público. <br>
                Aqui encontra toda a informação pública sobre os Contratos de Compras Públicas. <br>
                Consulte todas as informações sobre os Contratos Públicos de forma mais ágil e prática. <br>

            </p>
        </div>

        <div class="info-box">
            <p>Nos campos de seleção disponíveis deve selecionar as opções pretendidas para realizar a sua pesquisa,
                quanto maior for a seleção de campos mais reduzida será a lista de resultados.</p>
            <p>Pode realizar qualquer tipo de seleção, seja um objeto ou um espaço temporal, ou os dois.

                Caso não encontre o resultado desejado, reinicie a página e se possível elimine os cookies.

                Caso tenha dificuldade e necessite de suporte, regresse à página inicial das estatísticas e procure
                suporte na janela do chat ou através dos contactos disponibilizados no nosso website.</p>
        </div>
        </div>

        <div class="search-container">
            <div class="search-row">
                <div class="dropdown" id="contracts-dropdown">
                    <button id="dropdown-button" class="dropdown-select" aria-haspopup="true" aria-expanded="false">
                        <span class="dropdown-text" id="selected-contract">Contrato</span>
                        <i data-lucide="chevron-down" class="dropdown-icon"></i>
                    </button>

                    <div class="dropdown-menu" id="dropdown-menu">
                        <div class="dropdown-item" data-value="Contrato">Contrato</div>
                        <div class="dropdown-item" data-value="Entidades">Entidades</div>
                        <div class="dropdown-item" data-value="Modificações contratuais">Modificações contratuais</div>
                        <div class="dropdown-item" data-value="Bens móveis">Bens móveis</div>
                        <div class="dropdown-item" data-value="Não Celebrações de contrato">Não Celebrações de contrato
                        </div>
                        <div class="dropdown-item" data-value="Impugnação">Impugnação</div>
                    </div>
                </div>

                <input type="text" placeholder="Pesquisar pelo objeto do Contrato" class="search-input" />
                <button class="search-button">
                    <i data-lucide="search" class="icon-small"></i>
                    <span>Pesquisar</span>
                </button>
            </div>

            <!-- Advanced Search Form -->
            <div id="advanced-search-form" class="advanced-search-form">
                <div class="form-content">
                    <!-- First Row -->
                    <div class="form-row">
                        <div class="form-group">
                            <input type="checkbox" id="special-measures" class="form-checkbox" />
                            <label for="special-measures" class="form-label">
                                Medidas especiais
                            </label>
                        </div>

                        <div class="form-group">
                            <input type="checkbox" id="include-mec" class="form-checkbox" />
                            <label for="include-mec" class="form-label">
                                Incluir MEC ao abrigo do CCP
                            </label>
                        </div>

                        <div class="form-field">
                            <label for="measure-type" class="form-label">
                                Tipologia da medida especial
                            </label>
                            <select id="measure-type" class="form-select">
                                <option>Todos</option>
                                <option>Opção 1</option>
                                <option>Opção 2</option>
                            </select>
                        </div>
                    </div>

                    <hr class="form-divider" />

                    <!-- Second Row -->
                    <div class="form-row">
                        <div class="form-field">
                            <label for="procedure-type" class="form-label">
                                Tipo de Procedimento
                            </label>
                            <select id="procedure-type" class="form-select">
                                <option value="0">Todos</option>
                                <option value="8">Consulta Prévia</option>
                                <option value="1">Ajuste Direto Regime Geral</option>
                                <option value="2">Concurso público</option>
                                <option value="3">Concurso limitado por prévia qualificação</option>
                                <option value="4">Procedimento de negociação</option>
                                <option value="5">Diálogo concorrencial</option>
                                <option value="6">Ao abrigo de acordo-quadro (art.º 258.º)</option>
                                <option value="7">Ao abrigo de acordo-quadro (art.º 259.º)</option>
                                <option value="9">Parceria para a inovação</option>
                                <option value="10">Disponibilização de bens móveis</option>
                                <option value="11">Serviços sociais e outros serviços específicos</option>
                                <option value="13">Concurso de conceção simplificado</option>
                                <option value="14">Concurso de ideias simplificado</option>
                                <option value="15">Consulta Prévia Simplificada</option>
                                <option value="16">Concurso público simplificado</option>
                                <option value="17">Concurso limitado por prévia qualificação simplificado</option>
                                <option value="18">Ajuste Direto Regime Geral ao abrigo do artigo 7º da Lei n.º
                                    30/2021, de 21.05</option>
                                <option value="19">Consulta prévia ao abrigo do artigo 7º da Lei n.º 30/2021, de
                                    21.05</option>
                                <option value="20">Ajuste direto simplificado</option>
                                <option value="21">Ajuste direto simplificado ao abrigo da Lei n.º 30/2021, de 21.05
                                </option>
                                <option value="22">Setores especiais – isenção parte II</option>
                                <option value="23">Contratação excluída II</option>
                            </select>
                        </div>

                        <div class="form-field">
                            <label for="entity" class="form-label">
                                Entidade Adjudicante
                            </label>
                            <input type="text" id="entity" class="form-input" />
                        </div>
                    </div>

                    <!-- Third Row -->
                    <div class="form-row">
                        <div class="form-field">
                            <label for="contract-type" class="form-label">
                                Tipo de Contrato
                            </label>
                            <select id="contract-type" class="form-select">
                                <option value="0">Todos</option>
                                <option value="1">Aquisição de bens móveis</option>
                                <option value="2">Aquisição de serviços</option>
                                <option value="3">Concessão de obras públicas</option>
                                <option value="4">Concessão de serviços públicos</option>
                                <option value="5">Empreitadas de obras públicas</option>
                                <option value="6">Locação de bens móveis</option>
                                <option value="7">Sociedade</option>
                                <option value="8">Outros</option>
                            </select>
                        </div>

                        <div class="form-field">
                            <label for="awarded-entity" class="form-label">
                                Entidade Adjudicatária
                            </label>
                            <input type="text" id="awarded-entity" class="form-input" />
                        </div>
                    </div>

                    <!-- Fourth Row -->
                    <div class="form-row">
                        <div class="form-field">
                            <label for="cpv" class="form-label">
                                CPV
                            </label>
                            <input type="text" id="cpv" class="form-input" />
                        </div>

                        <div class="form-group">
                            <input type="checkbox" id="environmental-criteria" class="form-checkbox" />
                            <label for="environmental-criteria" class="form-label">
                                Critérios ambientais
                            </label>
                        </div>
                    </div>

                    <!-- Fifth Row - Dates and Location -->
                    <div class="form-row">
                        <div class="form-field date-container">
                            <label for="date-type" class="form-label">
                                Datas
                            </label>
                            <select id="date-type" class="form-select">
                                <option>Data do Contrato</option>
                                <option>Data de Publicação</option>
                                <option>Data de Fecho</option>
                            </select>

                            <div class="date-range">
                                <div class="date-field">
                                    <label for="date-from" class="form-label">De:</label>
                                    <div class="date-selects">
                                        <select id="from-year" class="date-select"></select>
                                        <select id="from-month" class="date-select"></select>
                                        <select id="from-day" class="date-select"></select>
                                    </div>
                                </div>

                                <div class="date-field">
                                    <label for="date-to" class="form-label">Até:</label>
                                    <div class="date-selects">
                                        <select id="to-year" class="date-select"></select>
                                        <select id="to-month" class="date-select"></select>
                                        <select id="to-day" class="date-select"></select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-field location-container">
                            <label class="form-label">
                                Local de Execução (País, Distrito, Concelho)
                            </label>
                            <select class="form-select location-select">
                                <option>Todos</option>
                                <option>Portugal</option>
                                <option>Espanha</option>
                            </select>
                            <select class="form-select location-select">
                                <option>Todos</option>
                                <option>Lisboa</option>
                                <option>Porto</option>
                                <option>Faro</option>
                            </select>
                            <select class="form-select location-select">
                                <option>Todos</option>
                                <option>Lisboa</option>
                                <option>Cascais</option>
                                <option>Sintra</option>
                            </select>
                        </div>
                    </div>

                    <!-- Form Buttons -->
                    <div class="form-buttons">
                        <button id="clear-form-btn" class="clear-button">
                            <i data-lucide="x" class="icon-small"></i>
                            <span>LIMPAR</span>
                        </button>
                        <button class="submit-button">
                            <i data-lucide="search" class="icon-small"></i>
                            <span>PESQUISAR</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay e Popup de Download -->
        <div class="overlay" id="overlay">
            <div class="popup">
                <button class="close-btn" id="closeBtn">&times;</button>
                <h2 class="popup-title">Formulário de Download</h2>

                <div id="downloadStep1" class="download-step active">
                    <form id="downloadForm">
                        <!-- Nome -->
                        <div class="overlay-form-group">
                            <label for="nome" class="form-label">Nome</label>
                            <input type="text" id="nome" name="nome" class="form-input" required>
                        </div>

                        <!-- Sobrenome -->
                        <div class="overlay-form-group">
                            <label for="sobrenome" class="form-label">Sobrenome</label>
                            <input type="text" id="sobrenome" name="sobrenome" class="form-input" required>
                        </div>

                        <!-- E-mail Profissional -->
                        <div class="overlay-form-group">
                            <label for="email" class="form-label">E-mail Profissional</label>
                            <input type="email" id="email" name="email" class="form-input" required>
                        </div>

                        <!-- Telefone Profissional -->
                        <div class="overlay-form-group">
                            <label for="telefone" class="form-label">Telefone Profissional</label>
                            <input type="tel" id="telefone" name="telefone" class="form-input" required>
                        </div>

                        <!-- Setor de Atividade Profissional -->
                        <div class="overlay-form-group">
                            <label for="setor" class="form-label">Setor de Atividade Profissional</label>
                            <select id="setor" name="setor" class="form-select" required>
                                <option value="" disabled selected>Selecione um setor</option>
                                <option value="01">01 - Agricultura, produção animal, caça e atividades dos serviços
                                    relacionados</option>
                                <option value="02">02 - Silvicultura e exploração florestal</option>
                                <option value="03">03 - Pesca e aquicultura</option>
                                <option value="05">05 - Extração de hulha e lenhite</option>
                                <option value="06">06 - Extração de petróleo bruto e gás natural</option>
                                <option value="07">07 - Extração e preparação de minérios metálicos</option>
                                <option value="08">08 - Outras indústrias extrativas</option>
                                <option value="09">09 - Atividades dos serviços relacionados com as indústrias
                                    extrativas</option>
                                <option value="10">10 - Indústrias alimentares</option>
                            </select>
                        </div>

                        <!-- Formato de Download -->
                        <div class="download-format-group">
                            <label class="form-label">Em que formato pretende efetuar o download:</label>
                            <div class="format-options">
                                <div class="format-option">
                                    <input type="radio" id="formatCsv" name="formato" value="csv" class="format-radio" required checked>
                                    <label for="formatCsv">CSV</label>
                                </div>
                                <div class="format-option">
                                    <input type="radio" id="formatXls" name="formato" value="xls" class="format-radio">
                                    <label for="formatXls">XLS</label>
                                </div>
                                <div class="format-option">
                                    <input type="radio" id="formatPdf" name="formato" value="pdf" class="format-radio">
                                    <label for="formatPdf">PDF</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">Continuar</button>
                    </form>
                </div>

                <!-- Etapa 2: Verificação por Email -->
                <div id="downloadStep2" class="download-step">
                    <div class="verification-container">
                        <div class="verification-icon">
                            <i data-lucide="mail"></i>
                        </div>
                        <h3>Verificação por Email</h3>
                        <p>Enviamos um código de verificação de 3 dígitos para o seu email.</p>
                        <p>Por favor, verifique sua caixa de entrada e insira o código abaixo:</p>

                        <div class="verification-code-container">
                            <input type="text" class="verification-input" maxlength="1" data-index="0">
                            <input type="text" class="verification-input" maxlength="1" data-index="1">
                            <input type="text" class="verification-input" maxlength="1" data-index="2">
                            <input type="text" class="verification-input" maxlength="1" data-index="3">
                            <input type="text" class="verification-input" maxlength="1" data-index="4">                        </div>

                        <div class="verification-actions">
                            <button id="verifyCodeBtn" class="submit-btn">Verificar</button>
                            <button id="resendCodeBtn" class="resend-btn">Reenviar Código</button>
                        </div>
                    </div>
                </div>

                <!-- Etapa 3: Download Concluído -->
                <div id="downloadStep3" class="download-step">
                    <div class="success-container">
                        <div class="success-icon">
                            <i data-lucide="check-circle" class="icon-large"></i>
                        </div>
                        <h3>Download Pronto!</h3>
                        <p>Seu download começará automaticamente em alguns segundos.</p>
                        <p>Se o download não iniciar, clique no botão abaixo:</p>

                        <a href="#" id="downloadLink" class="download-link">
                            <i data-lucide="download" class="icon-small"></i>
                            <span>Baixar Arquivo</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </main>
    <%- include('components/tab_base') %>
        <%- include('components/detalhes') %>
            <%- include('components/mail_receive') %>
                <%- include('components/button') %>

                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            // ========== Utils ==========
                            const qs = (s, p = document) => p.querySelector(s);
                            const qsa = (s, p = document) => [...p.querySelectorAll(s)];

                            // ========== Preencher selects de data ==========
                            function populateDateSelectors(yearId, monthId, dayId) {
                                const yearSelect = document.getElementById(yearId);
                                const monthSelect = document.getElementById(monthId);
                                const daySelect = document.getElementById(dayId);

                                const currentYear = new Date().getFullYear();

                                // Placeholders
                                yearSelect.innerHTML = '<option disabled selected>Ano:</option>';
                                monthSelect.innerHTML = '<option disabled selected>Mês:</option>';
                                daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                // Preencher anos (do ano atual até 1900)
                                for (let y = currentYear; y >= 1900; y--) {
                                    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
                                }

                                // Preencher meses (01 a 12)
                                for (let m = 1; m <= 12; m++) {
                                    const paddedMonth = m.toString().padStart(2, '0');
                                    monthSelect.innerHTML += `<option value="${m}">${paddedMonth}</option>`;
                                }

                                // Atualizar dias com base no mês e ano selecionados
                                function updateDays() {
                                    const year = parseInt(yearSelect.value);
                                    const month = parseInt(monthSelect.value);

                                    if (!year || !month) return;

                                    const daysInMonth = new Date(year, month, 0).getDate();
                                    daySelect.innerHTML = '<option disabled selected>Dia:</option>';

                                    for (let d = 1; d <= daysInMonth; d++) {
                                        const paddedDay = d.toString().padStart(2, '0');
                                        daySelect.innerHTML += `<option value="${d}">${paddedDay}</option>`;
                                    }
                                }

                                yearSelect.addEventListener('change', updateDays);
                                monthSelect.addEventListener('change', updateDays);

                                // Inicializar com valores padrão
                                yearSelect.value = currentYear;
                                monthSelect.value = 1;
                                updateDays();
                            }

                            populateDateSelectors('from-year', 'from-month', 'from-day');
                            populateDateSelectors('to-year', 'to-month', 'to-day');


                            // ========== Ícones Lucide ==========
                            (typeof lucide === 'undefined' ? { createIcons: () => { } } : lucide).createIcons();

                            // ========== Limpar formulário ==========
                            qs('#clear-form-btn')?.addEventListener('click', () => {
                                const form = qs('#advancedSearchForm');
                                form?.querySelectorAll('input').forEach(i => i.type === 'checkbox' ? i.checked = false : i.value = '');
                                form?.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                            });

                            // ========== Mostrar resultados ==========
                            const resultsTable = qs('#results-table');
                            const notifContainer = qs('#notificacao-container');
                            qsa('.search-button, .submit-button').forEach(btn =>
                                btn.addEventListener('click', () => {
                                    resultsTable?.style.setProperty('display', 'block');
                                    notifContainer?.style.setProperty('display', 'block');
                                    resultsTable?.scrollIntoView({ behavior: 'smooth' });
                                })
                            );

                            // ========== Detalhes de contratos ==========
                            const contractDetails = qsa('.contract-details');
                            const toggleDetail = (id, show) => {
                                contractDetails.forEach(el => el.style.display = el.id === `details-${id}` && show ? 'block' : 'none');
                                const btn = qs(`.details-button[data-contract-id="${id}"]`);
                                const icon = btn?.querySelector('i');
                                qs('#main-container')?.style.setProperty('display', show ? 'block' : 'none');
                                icon?.classList.toggle('fa-plus-circle', !show);
                                icon?.classList.toggle('fa-minus-circle', show);
                                (show ? qs('#main-container') : qs('.results-table'))?.scrollIntoView({ behavior: 'smooth' });
                            };

                            qsa('.details-button').forEach(btn => {
                                const id = btn.dataset.contractId;
                                ['click', 'keydown'].forEach(evt => {
                                    btn.addEventListener(evt, e => {
                                        if (evt === 'click' || ['Enter', ' '].includes(e.key)) {
                                            e.preventDefault?.();
                                            toggleDetail(id, true);
                                        }
                                    });
                                });
                            });

                            qsa('.close-details').forEach(btn => {
                                const id = btn.dataset.contractId;
                                ['click', 'keydown'].forEach(evt => {
                                    btn.addEventListener(evt, e => {
                                        if (evt === 'click' || ['Enter', ' '].includes(e.key)) {
                                            e.preventDefault?.();
                                            toggleDetail(id, false);
                                        }
                                    });
                                });
                            });

                            // ========== Dropdown ==========
                            const dropdownBtn = qs('#dropdown-button');
                            const dropdownMenu = qs('#dropdown-menu');
                            const searchInput = qs('.search-input');
                            const selectedContract = qs('#selected-contract');

                            const placeholderMap = {
                                Contrato: "Pesquisar pelo objeto do Contrato",
                                Anúncios: "Pesquisar pelo objeto do Anúncio",
                                Entidades: "Pesquisar pelo nome da Entidade",
                                "Modificações contratuais": "Pesquisar pela modificação contratual",
                                "Bens móveis": "Pesquisar pelo bem móvel",
                                "Não Celebrações de contrato": "Pesquisar pela não celebração",
                                Impugnação: "Pesquisar pela impugnação",
                            };

                            dropdownBtn?.addEventListener('click', () => {
                                const expanded = dropdownBtn.getAttribute("aria-expanded") === "true";
                                dropdownBtn.setAttribute("aria-expanded", String(!expanded));
                                dropdownMenu.style.display = expanded ? "none" : "block";
                            });

                            document.addEventListener('click', e => {
                                if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                                    dropdownBtn.setAttribute("aria-expanded", "false");
                                    dropdownMenu.style.display = "none";
                                }
                            });

                            qsa('.dropdown-item').forEach(item =>
                                item.addEventListener('click', e => {
                                    const val = e.currentTarget.dataset.value;
                                    selectedContract.textContent = val;
                                    searchInput.placeholder = placeholderMap[val] || '';
                                    dropdownBtn.setAttribute("aria-expanded", "false");
                                    dropdownMenu.style.display = "none";
                                })
                            );

                            // ========== Popup de Download ==========
                            const openBtn = qs('#openPopupBtn'), closeBtn = qs('#closeBtn'), overlay = qs('#overlay');
                            const form = qs('#downloadForm'), verifyBtn = qs('#verifyCodeBtn'), resendBtn = qs('#resendCodeBtn');
                            const step1 = qs('#downloadStep1'), step2 = qs('#downloadStep2'), step3 = qs('#downloadStep3');
                            const inputs = qsa('.verification-input');
                            let code = '', email = '';

                            const showStep = step => [step1, step2, step3].forEach(s => s.classList.toggle('active', s === step));
                            const genCode = () => (code = Math.floor(100 + Math.random() * 900).toString());
                            const sendCode = (email, code) => {
                                console.log(`Enviando código ${code} para ${email}`);
                                return new Promise(res => setTimeout(() => res(true), 1000));
                            };

                            openBtn?.addEventListener('click', () => {
                                overlay.style.display = 'flex';
                                document.body.style.overflow = 'hidden';
                            });

                            const closePopup = () => {
                                overlay.style.display = 'none';
                                document.body.style.overflow = 'auto';
                                showStep(step1);
                                form.reset();
                            };

                            closeBtn?.addEventListener('click', closePopup);
                            overlay?.addEventListener('click', e => e.target === overlay && closePopup());

                            form?.addEventListener('submit', e => {
                                e.preventDefault();
                                email = qs('#email').value;
                                sendCode(email, genCode()).then(() => {
                                    showStep(step2);
                                    inputs[0]?.focus();
                                });
                            });
                        });
                    </script>

</body>

</html>